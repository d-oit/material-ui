### **Ticket 5: Implement PWA Features**  
**Role:** Frontend Developer (FE)  

---

#### **Description**  
Configure the application as a Progressive Web App (PWA) using the [Vite PWA plugin](https://vite-pwa-org.netlify.app/guide/). Enable offline support, caching, and data synchronization to ensure the app functions reliably without an internet connection.  

---

#### **Acceptance Criteria**  
1. PWA manifest and service worker are configured.  
2. Core assets (HTML, CSS, JS) are cached for offline access.  
3. Links and user data are synchronized when the app regains connectivity.  
4. The app passes Lighthouse PWA audits (installable, offline support).  
5. PWA metadata (icons, theme colors) align with the app’s design.  

---

### **Implementation Steps**  

#### **1. Install Dependencies**  
```bash
npm install vite-plugin-pwa @vitejs/plugin-react-swc workbox-window
```

#### **2. Configure Vite PWA Plugin**  
```ts
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react-swc';
import { VitePWA } from 'vite-plugin-pwa';

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      manifest: {
        name: 'do Links Collector',
        short_name: 'LinksCollector',
        description: 'Save and organize web links offline.',
        theme_color: '#1976d2',
        icons: [
          {
            src: '/icons/icon-192x192.png',
            sizes: '192x192',
            type: 'image/png',
          },
          {
            src: '/icons/icon-512x512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any maskable',
          },
        ],
      },
      workbox: {
        runtimeCaching: [
          {
            urlPattern: ({ url }) => url.pathname.startsWith('/api'),
            handler: 'NetworkFirst',
            options: {
              cacheName: 'api-cache',
              expiration: { maxEntries: 50 },
            },
          },
          {
            urlPattern: ({ request }) => request.destination === 'asset',
            handler: 'CacheFirst',
          },
        ],
      },
    }),
  ],
});
```

#### **3. Add Service Worker Registration**  
```tsx
// src/service-worker.ts
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js');
  });
}
```

#### **4. Create a Custom Hook for Offline Sync**  
```tsx
// src/hooks/useOfflineSync.ts
import { useEffect } from 'react';
import { useQueryClient } from '@tanstack/react-query';
import { Workbox } from 'workbox-window';

export const useOfflineSync = () => {
  const queryClient = useQueryClient();

  useEffect(() => {
    const wb = new Workbox('/service-worker.js');
    wb.addEventListener('activated', () => {
      // Sync Tanstack Query cache when online
      window.addEventListener('online', () => {
        queryClient.invalidateQueries();
      });
    });
    wb.register();
  }, [queryClient]);
};
```

#### **5. Integrate with Tanstack Query for Offline Mutations**  
```tsx
// src/hooks/useCreateLink.ts (updated for offline support)
import { useMutation } from '@tanstack/react-query';
import pb from '../services/pocketbase';
import { set } from 'idb-keyval';

export const useCreateLink = () => {
  return useMutation(
    async (newLink: { url: string; title: string }) => {
      if (!navigator.onLine) {
        // Store mutation in IndexedDB for later sync
        await set(`pendingLink-${Date.now()}`, newLink);
        throw new Error('Offline: Link saved locally');
      }
      return pb.collection('links').create(newLink);
    },
    {
      onSettled: () => {
        if (navigator.onLine) {
          // Sync pending mutations when online
          // (Implement logic to retry stored IDB mutations)
        }
      },
    }
  );
};
```

#### **6. Add PWA Metadata and Icons**  
- Create `public/icons/icon-192x192.png` and `public/icons/icon-512x512.png`.  
- Add `public/manifest.webmanifest` (auto-generated by the plugin).  

#### **7. Update App Component**  
```tsx
// src/App.tsx
import { useEffect } from 'react';
import { useOfflineSync } from './hooks/useOfflineSync';
import { ToastContainer, toast } from 'react-toastify';
import 'react-toastify/dist/ReactToastify.css';

const App = () => {
  useOfflineSync();

  useEffect(() => {
    // Show offline/online status toasts
    const handleOnline = () => toast.success('Back online! Syncing data...');
    const handleOffline = () => toast.warn('Offline: Changes saved locally.');
    
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  return (
    <>
      {/* Your app components */}
      <ToastContainer position="bottom-right" />
    </>
  );
};
```

---

### **Testing**  
1. Run `npm run build && npm run preview` to test the production build.  
2. Use Lighthouse to audit PWA compliance.  
3. Test offline functionality:  
   - Disable network, add a link, and verify it’s stored locally.  
   - Re-enable network and confirm synchronization.  
4. Validate service worker registration in DevTools → Application → Service Workers.  

---

### **Future Enhancements**  
1. Implement background sync for pending mutations.  
2. Add push notifications for sync completion.  
3. Cache PocketBase API responses more aggressively.  

---

This ticket ensures the app works reliably offline and meets modern PWA standards. Let me know if further refinements are needed!
